generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model users {
  id                      String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email                   String?                     @unique @db.Citext
  role                    user_role
  display_name            String?
  bio                     String?
  country_code            String?
  is_verified             Boolean                     @default(false)
  created_at              DateTime                    @default(now()) @db.Timestamptz(6)
  updated_at              DateTime                    @default(now()) @db.Timestamptz(6)
  deleted_at              DateTime?                   @db.Timestamptz(6)
  password                String?
  address                 String?                     @unique
  chain                   chain_type                  @default(evm)
  image_id                String                      @default("default.jpg")
  finished_job_num        Decimal                     @default(0)
  total_fund              Decimal                     @default(0)
  fund_cycle              Decimal?
  fund_num                Decimal?             
  audits                  audit_log[]                 @relation("ActorAudits")
  chain_txs               chain_txs[]
  conversations           conversation_participants[]
  bids                    job_bids[]
  milestones              job_milestones[]            @relation("MilestoneCreators")
  jobs                    jobs[]                      @relation("ClientJobs")
  receipts                message_receipts[]
  sent_messages           messages[]                  @relation("SenderMessages")
  notifications           notifications[]             @relation("NotificationRecipient")
  notifications_as_actor  notifications[]             @relation("NotificationActor")
  client_applications     job_applications_docs[]     @relation("ClientApplications")
  freelancer_applications job_applications_docs[]     @relation("FreelancerApplications")

  @@map("users")
}

model jobs {
  id                  String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  client_id           String                  @db.Uuid
  title               String
  description_md      String
  budget_min          Decimal?                @db.Decimal(18, 8)
  budget_max          Decimal?                @db.Decimal(18, 8)
  token_symbol        String?
  deadline_at         DateTime?               @db.Timestamptz(6)
  status              job_status              @default(open)
  is_remote           Boolean                 @default(true)
  created_at          DateTime                @default(now()) @db.Timestamptz(6)
  updated_at          DateTime                @default(now()) @db.Timestamptz(6)
  image_id            String?
  location            location_type           @default(remote)
  tags                String[]
  conversations       conversations[]
  bids                job_bids[]
  milestones          job_milestones[]
  client              users                   @relation("ClientJobs", fields: [client_id], references: [id])
  jobApplicationsDocs job_applications_docs[]

  @@index([status, created_at(sort: Desc)])
  @@map("jobs")
}

model gigs {
  id             String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  freelancer_id  String          @db.Uuid
  title          String
  description_md String
  budget_min     Decimal?        @db.Decimal(18, 8)
  budget_max     Decimal?        @db.Decimal(18, 8)
  token_symbol   String?
  tags           String[]
  image_id       String?
  created_at     DateTime        @default(now()) @db.Timestamptz(6)
  updated_at     DateTime        @default(now()) @db.Timestamptz(6)
  link           String?
  conversations  conversations[]

  @@index([created_at(sort: Desc)])
  @@map("gigs")
}

model job_bids {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  job_id          String     @db.Uuid
  freelancer_id   String     @db.Uuid
  cover_letter_md String?
  bid_amount      Decimal?   @db.Decimal(18, 8)
  status          bid_status @default(pending)
  created_at      DateTime   @default(now()) @db.Timestamptz(6)
  token_symbol    String?
  updated_at      DateTime   @default(now()) @db.Timestamptz(6)
  period          Int?
  freelancer      users      @relation(fields: [freelancer_id], references: [id], onDelete: Cascade)
  job             jobs       @relation(fields: [job_id], references: [id], onDelete: Cascade)

  @@unique([job_id, freelancer_id])
  @@index([job_id, status])
  @@map("job_bids")
}

model job_milestones {
  id                  String                  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  job_id              String                  @db.Uuid
  title               String
  amount              Decimal                 @db.Decimal(18, 8)
  due_at              DateTime?               @db.Timestamptz(6)
  order_index         Int                     @default(1)
  status              milestone_status        @default(pending_fund)
  created_at          DateTime                @default(now()) @db.Timestamptz(6)
  token_symbol        String?
  escrow              String?
  ipfs                String?
  updated_at          DateTime                @default(now()) @db.Timestamptz(6)
  freelancer_id       String                  @db.Uuid
  freelancer          users                   @relation("MilestoneCreators", fields: [freelancer_id], references: [id])
  job                 jobs                    @relation(fields: [job_id], references: [id], onDelete: Cascade)
  jobApplicationsDocs job_applications_docs[]
  chainTxs            chain_txs[]

  @@unique([job_id, order_index])
  @@map("job_milestones")
}

model job_applications_docs {
  id                   String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  job_id               String          @db.Uuid
  job_milestone_id     String?         @db.Uuid
  client_id            String          @db.Uuid
  freelancer_id        String          @db.Uuid
  client_confirm       Boolean         @default(false)
  freelancer_confirm   Boolean         @default(false)
  confirm_edit_rounds  Int             @default(0) // 0..2: max 2 rounds of edit-then-confirm (other must re-confirm)
  deliverables         String?
  out_of_scope         String?
  budget               Decimal?
  token_symbol         String?
  start_date           DateTime?       @db.Timestamptz(6)
  end_date             DateTime?       @db.Timestamptz(6)
  created_at           DateTime        @default(now()) @db.Timestamptz(6)
  updated_at           DateTime        @default(now()) @db.Timestamptz(6)
  job                jobs            @relation(fields: [job_id], references: [id], onDelete: Cascade)
  job_milestone      job_milestones? @relation(fields: [job_milestone_id], references: [id], onDelete: Cascade)
  client             users           @relation("ClientApplications", fields: [client_id], references: [id], onDelete: Cascade)
  freelancer         users           @relation("FreelancerApplications", fields: [freelancer_id], references: [id], onDelete: Cascade)
  chats              conversations[]

  @@map("job_applications_docs")
}

model conversations {
  id                     String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type                   convo_type                  @default(dm)
  job_id                 String?                     @db.Uuid
  created_at             DateTime                    @default(now()) @db.Timestamptz(6)
  escrow                 String?
  gig_id                 String?                     @db.Uuid
  job_application_doc_id String?                     @db.Uuid
  participants           conversation_participants[]
  gig                    gigs?                       @relation(fields: [gig_id], references: [id])
  job                    jobs?                       @relation(fields: [job_id], references: [id])
  messages               messages[]
  jobApplicationsDocs    job_applications_docs?      @relation(fields: [job_application_doc_id], references: [id])

  @@map("conversations")
}

model conversation_participants {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id  String        @db.Uuid
  user_id          String        @db.Uuid
  is_muted         Boolean       @default(false)
  blocked_until    DateTime?     @db.Timestamptz(6)
  is_pinned        Boolean       @default(false)
  last_read_msg_id String?       @db.Uuid
  conversation     conversations @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  last_read        messages?     @relation("LastReadPointer", fields: [last_read_msg_id], references: [id])
  user             users         @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([conversation_id, user_id])
  @@index([user_id])
  @@map("conversation_participants")
}

model messages {
  id              String                      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  conversation_id String                      @db.Uuid
  sender_id       String                      @db.Uuid
  kind            msg_type                    @default(text)
  body_text       String?
  attachment_id   String?                     @db.Uuid
  reply_to_msg_id String?                     @db.Uuid
  created_at      DateTime                    @default(now()) @db.Timestamptz(6)
  edited_at       DateTime?                   @db.Timestamptz(6)
  deleted_at      DateTime?                   @db.Timestamptz(6)
  last_read_of    conversation_participants[] @relation("LastReadPointer")
  receipts        message_receipts[]
  conversation    conversations               @relation(fields: [conversation_id], references: [id], onDelete: Cascade)
  reply_to        messages?                   @relation("MessageReplies", fields: [reply_to_msg_id], references: [id])
  replies         messages[]                  @relation("MessageReplies")
  sender          users                       @relation("SenderMessages", fields: [sender_id], references: [id], onDelete: Cascade)

  @@index([conversation_id, created_at])
  @@map("messages")
}

model message_receipts {
  id         String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  message_id String     @db.Uuid
  user_id    String     @db.Uuid
  state      read_state
  created_at DateTime   @default(now()) @db.Timestamptz(6)
  message    messages   @relation(fields: [message_id], references: [id], onDelete: Cascade)
  user       users      @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([message_id, user_id])
  @@map("message_receipts")
}

model chain_txs {
  id               String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  purpose          String
  chain_id         Int
  job_milestone_id String?         @db.Uuid
  from_address     String
  to_address       String?
  tx_hash          String?         @unique
  status           String
  created_at       DateTime        @default(now()) @db.Timestamptz(6)
  updated_at       DateTime        @default(now()) @db.Timestamptz(6)
  user_id          String?         @db.Uuid
  user             users?          @relation(fields: [user_id], references: [id])
  job_milestone    job_milestones? @relation(fields: [job_milestone_id], references: [id], onDelete: Cascade)

  @@map("chain_txs")
}

model notifications {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  user_id String @db.Uuid

  type        notification_type
  entity_type notification_entity
  entity_id   String

  actor_user_id String? @db.Uuid

  title   String
  body    String
  payload Json?

  read_at    DateTime? @db.Timestamptz(6)
  created_at DateTime  @default(now()) @db.Timestamptz(6)

  user  users  @relation("NotificationRecipient", fields: [user_id], references: [id], onDelete: Cascade)
  actor users? @relation("NotificationActor", fields: [actor_user_id], references: [id])

  @@index([user_id, read_at])
  @@index([entity_type, entity_id])
  @@map("notifications")
}

model audit_log {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  actor_user_id String?  @db.Uuid
  action        String
  entity_table  String
  entity_id     String   @db.Uuid
  meta          Json?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  actor         users?   @relation("ActorAudits", fields: [actor_user_id], references: [id])

  @@map("audit_log")
}

model system_settings {
  id                      String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  key                     String   @unique @default("default")
  fee_bps                 Int      @default(100)
  buyer_fee_bps           Int      @default(50)
  vendor_fee_bps          Int      @default(50)
  dispute_fee_bps         Int      @default(50)
  reward_rate_bps         Int      @default(25)
  reward_rate_per_1_e_18  String   @default("30000000000000000000000")
  arbiter_address         String   @default("")
  fee_recipient_address   String   @default("")
  created_at              DateTime @default(now()) @db.Timestamptz(6)
  updated_at              DateTime @default(now()) @db.Timestamptz(6)

  @@map("system_settings")
}

/// ---------- Enums ----------
enum user_role {
  client
  freelancer
  admin
}

enum location_type {
  remote
  onsite
  hybrid
}

enum job_status {
  draft
  open
  in_review
  in_progress
  completed
  cancelled
}

enum bid_status {
  pending
  accepted
  declined
  withdrawn
}

enum milestone_status {
  pending_fund
  funded
  delivered
  approved
  released
  disputedByClient
  disputedByFreelancer
  disputedWithCounterSide
  resolvedToBuyer
  resolvedToVendor
  cancelled
}

enum chain_type {
  evm
}

enum token_type {
  native
  erc20
}

enum escrow_state {
  unfunded
  funded
  delivered
  disputed
  releasable
  paid
  refunded
}

enum dispute_status {
  open
  awaiting_fees
  panel_assigned
  evidence
  deliberation
  resolved
  dismissed
}

enum convo_type {
  dm
}

enum msg_type {
  text
  image
  file
  system
}

enum read_state {
  sent
  delivered
  read
}

enum notification_type {
  JOB_POSTED
  JOB_UPDATED
  JOB_EXPIRING_SOON
  GIG_POSTED
  GIG_UPDATED
  BID_SENT
  BID_RECEIVED
  BID_ACCEPTED
  BID_DECLIEND
  BID_WITHDRAWN
  MILESTONE_ESCROW_DEPLOYED
  MILESTONE_STARTED
  MILESTONE_FUNDED
  MILESTONE_DELIVERED
  MILESTONE_APPROVED
  MILESTONE_FUNDS_RELEASED
  MILESTONE_CANCELLED
  DISPUTE_STARTED
  DISPUTE_RESOLVED
  MESSAGE_RECEIVED
  REQUIREMENT_DOCS_CREATED
  REQUIREMENT_DOCS_CONFIRMED
  CHAT_CREATED
  CHAT_UPDATED
  DEPOSIT_FUNDS
  DELIVER_WORK
  APPROVE_WORK
  WITHDRAW_FUNDS
}

enum notification_entity {
  job
  job_application_doc
  gig
  bid
  milestone
  escrow
  dispute
  conversation
  chain_tx
}
